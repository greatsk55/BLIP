# BLIP 애널리틱스 전략 설계서

## Context

BLIP은 "흔적 없이 사라지는 일시적 채팅 서비스"입니다. 핵심 철학은 **"보유하지 않은 데이터는 제공할 수 없음"**이며, 계정/로그인/메시지 저장이 없습니다. 그러나 서비스 개선과 광고 수익 모델을 위해 **최소한의 애널리틱스**가 필요합니다.

**근본적 긴장**: 프라이버시 철학 vs 데이터 기반 의사결정
**해결 원칙**: "봉투만 본다, 편지는 보지 않는다" - 구조적 메타데이터만 수집하고 내용은 절대 건드리지 않는다

---

## 1. 데이터 애널리틱스 관점: "무엇을 측정할 것인가"

### 1.1 핵심 KPI 3가지

| KPI | 측정 지표 | 수집 방법 |
|-----|----------|-----------|
| **방 생성수** | 일별/시간별 방 생성 수 | WebSocket 서버 사이드 카운터 |
| **대화 전송수** | 방당 암호화 패킷 중계 횟수 (집계) | WebSocket 서버 패킷 카운터 |
| **방 생존시간** | 방 생성~파괴 duration (초) | WebSocket 서버 타임스탬프 |

**대화 전송수 보안 원칙**: 서버가 E2E 암호화된 패킷을 중계하므로 "패킷 수를 세는 것 = 봉투를 세는 것"이지 편지를 읽는 것이 아님. 단, 방 단위 집계만 허용하고 타이밍 패턴 분석은 금지.

### 1.2 보조 지표

```
웹 트래픽:
- DAU (쿠키 없는 고유 방문자), pageview, CTA 클릭률

방 운영:
- 종료 유형별 비율 (자연종료 / 이탈 / TTL만료 / 미참여)
- 방당 평균 참여자 수
- 초대 링크 전환율 (생성 대비 참여)

광고:
- 광고 노출수, CTR, 화면별 성과
```

### 1.3 5단계 퍼널

```
[랜딩 방문] → [CTA 클릭] → [방 생성/참여] → [대화 진행] → [방 종료/파괴]
  Stage 1        Stage 2       Stage 3         Stage 4        Stage 5
  클라이언트     클라이언트      서버사이드       서버사이드      서버사이드
```

- Stage 1~2: Umami (클라이언트)가 측정
- Stage 3~5: 자체 서버사이드 시스템이 측정 (조작 방지)

### 1.4 이벤트 정의 (SSOT)

```
web/src/analytics/events.ts 에 단일 정의:

퍼널 이벤트:
- page_view, section_view, cta_click
- room_create, room_link_copy, room_join
- room_active
- room_end_natural, room_end_abandon, room_end_ttl, room_end_no_join

방 메트릭 (서버사이드 전용):
- message_relayed (패킷 중계 - 방 단위 집계만, 개인별 X)

광고 이벤트:
- ad_impression, ad_click
```

### 1.5 계정 없는 환경에서의 DAU 측정

- **DAU**: `hash(IP + User-Agent + daily_salt)` → 다음 날 salt 변경으로 추적 불가 (Umami 기본 방식)
- **재방문**: 선택적 동의 기반 localStorage 익명 토큰 (동의 거부 시 수집 안 함)
- **A/B 테스트**: sessionStorage 기반 (탭 닫으면 소멸 = BLIP 철학)

---

## 2. 보안 전문가 관점: "무엇을 절대 수집하지 않을 것인가"

### 2.1 데이터 경계선

```
GREEN (수집 가능):                    RED (수집 금지):
─────────────────                    ─────────────────
일별 총 방 생성 수                     메시지 내용 (E2E이므로 기술적으로도 불가)
방당 패킷 중계 횟수 (집계)              개인별 메시지 수
방 생존 시간 분포                      타이핑 패턴/속도/메시지 간격
종료 사유별 비율                       IP 주소 원본 저장
일별 총 pageview                      브라우저 fingerprint
언어별/기기별 비율                     크로스 세션 추적
시간대별 사용량                        참여자 간 관계 그래프
                                     방문 히스토리 (어떤 방에 참여했는지)

YELLOW (해시/집계 후에만):
─────────────────────
IP → hash(IP + daily_salt) 후 DAU 계산, 원본 즉시 폐기
User-Agent → mobile/desktop 분류 후 원본 폐기
Referer → 도메인 추출 후 원본 폐기
```

### 2.2 데이터 보존 정책 (데이터에도 TTL)

```
즉시 폐기:   IP 원본, User-Agent 원본, Referer 원본
24시간 보존: Rate limit 로그, 개별 방 메타데이터 (방 생성수/전송수/생존시간)
7일 보존:    일별 집계 데이터
영구 보존:   월별/연별 집계 통계만 (개인 식별 완전 불가)
```

### 2.3 E2E 암호화와 애널리틱스의 분리

```
[클라이언트 A] ←─ E2E 암호화 ─→ [클라이언트 B]
                      |
               [WebSocket 서버]
               (전달자 역할만)
                      |
              서버가 볼 수 있는 것:          서버가 절대 볼 수 없는 것:
              - 방 생성/삭제 시점              - 메시지 내용
              - 참여자 수 (연결 수)            - 대화 주제
              - 방 생존 시간                   - 타이핑 패턴
              - 중계 패킷 수 (집계)            - 개인별 메시지 빈도
              - 연결/끊김 이벤트               - 메시지 간 시간 간격
```

### 2.4 인프라 보안: Vercel 호스팅 리스크 분석

**Vercel에 애널리틱스를 함께 두면 위험한 이유:**

| 리스크 | 설명 | 심각도 |
|--------|------|--------|
| **단일 영장** | 하나의 법적 요청으로 앱 + 애널리틱스 데이터 동시 확보 가능 | 높음 |
| **메타데이터 노출** | Vercel이 모든 HTTP 요청의 메타데이터(IP, UA, 경로) 접근 가능 | 높음 |
| **DPA 예외 조항** | Vercel이 "익명화/집계 메트릭"을 자체 보고/통계에 활용 가능 (범위 모호) | 중간 |
| **단일 장애점** | Vercel 장애 시 앱 + 애널리틱스 동시 다운 | 중간 |
| **계정 탈취** | Vercel 계정 하나로 소스코드 + 환경변수 + 애널리틱스 모두 노출 | 높음 |
| **서브프로세서 체인** | 미국 CLOUD Act 하 해외 데이터도 제출 의무 | 중간 |

**결론: 앱과 애널리틱스는 반드시 다른 인프라에 분리해야 함**

### 2.5 인프라 대안 비교

| 옵션 | 비용 | 프라이버시 | 데이터 주권 | 커스텀 이벤트 | BLIP 적합도 |
|------|------|----------|-----------|-------------|------------|
| **Railway + Umami** (1순위) | ~$5/월 | 높음 | 완전 | 완전 | **최적** |
| Fly.io + Umami | ~$3-5/월 | 높음 | 완전 | 완전 | 우수 |
| Cloudflare Web Analytics | 무료 | 높음 | 없음 | 제한적 | 보조용 |
| Vercel + Umami | 무료 | 중간 | 부분적 | 완전 | **비추천** |
| Vercel Analytics | 무료~유료 | 낮음 | 없음 | 제한적 | **비추천** |

**1순위 추천: Railway에 Umami 셀프호스팅**
- 원클릭 배포 템플릿 지원
- PostgreSQL DB 자동 프로비저닝
- 앱(Vercel)과 애널리틱스(Railway)의 법적/기술적 완전 분리
- 월 ~$5 수준의 합리적 비용

**보조 추천: Cloudflare Web Analytics 병행**
- 완전 무료, 쿠키 없음
- 기본 트래픽 데이터 이중 확보 (Railway 장애 시 백업)

### 2.6 유출 영향 분석

```
Umami 데이터 유출 시:     위험 낮음 (페이지 URL, 기기 유형, 국가 = 개인 식별 불가)
방 메타데이터 유출 시:     위험 낮음 (해시된 방ID, 생존시간, 패킷수 = 사용자 식별 불가)
Rate limit 로그 유출 시:  위험 중간 (hash(IP) 레인보우 테이블 → 강력한 salt + 24시간 TTL로 완화)
```

---

## 3. 스토리텔러 관점: "어떻게 이야기할 것인가"

### 3.1 핵심 내러티브

```
서비스 철학:     "대화는 남기지 않는다"
애널리틱스 철학:  "분석도 남기지 않는다"

다른 서비스: "Trust us" (우리를 믿으세요)
BLIP:       "Verify us" (직접 확인하세요)
```

**슬로건**: "우리는 당신의 대화뿐 아니라, 당신의 방문 기록도 추적하지 않습니다."

### 3.2 투명성을 브랜딩 자산으로

#### (a) 실시간 투명성 대시보드 (`/transparency`)

```
[BLIP이 보는 것]                       [BLIP이 보지 않는 것]
  오늘 만들어진 방: 1,234개               당신의 IP 주소    ❌
  오늘 전송된 대화: 23,456건              당신의 대화 내용  ❌
  가장 긴 대화: 47분                      당신이 누구인지   ❌
  지금 활성 방: 89개

  [수집된 개인정보: 0 bytes]
```

→ **"수집된 개인정보: 0 bytes"** = 가장 강력한 마케팅 카피

#### (b) 개발자 도구 안내

"F12를 눌러 네트워크 탭을 확인해보세요. BLIP이 보내는 모든 데이터가 거기 있습니다."

→ 오픈소스 코드 + 네트워크 탭 가이드 + 투명성 대시보드 = **"trustless trust"**

#### (c) 월간 투명성 보고서

```
- 총 방 생성/파괴: 45,678개 (100% 파괴 완료)
- 정부 데이터 요청: 0건 (보유 데이터 없음)
- 개인정보 침해 사고: 0건
```

### 3.3 광고주 설득: "프라이버시 프리미엄"

```
셀링 포인트:
1. 높은 주목도 (대화 전/후 대기 시간의 광고)
2. 브랜드 세이프티 (대화 내용과 광고가 무관)
3. 프라이버시 친화 브랜드 이미지 연계
4. AdBlocker 사용자도 BLIP에서는 차단하지 않음 (프라이버시를 침해하지 않으므로)
```

광고 데이터: 노출 수, CTR, 화면별/시간대별/국가별 성과만 제공. 타겟팅/리타겟팅 불가.

---

## 4. 세 관점의 충돌 해결

| 충돌 지점 | 해결 방법 |
|----------|----------|
| 대화 전송수 측정 vs 프라이버시 | 방 단위 집계만 허용, 타이밍 패턴 분석 금지, 24시간 TTL 후 삭제 |
| 재방문률 vs fingerprinting 금지 | 선택적 동의 토큰 + 집계 추정 병행 (정확도 포기) |
| 광고 최적화 vs 프로필링 금지 | 컨텍스트 광고만 (위치+시간 기반), 프라이버시 프리미엄 포지셔닝 |
| 인프라 편의 vs 보안 분리 | 앱(Vercel) ≠ 애널리틱스(Railway) 필수 분리 |

**통합 원칙 4가지**:
1. 측정하지 못하는 것은 포기한다 (프라이버시 > 정확도)
2. 서버는 봉투만 본다 (구조 메타데이터만, 내용 절대 금지)
3. 수집하는 것은 모두 공개한다 (오픈소스 + 투명성 페이지)
4. 데이터에도 TTL이 있다 (보존 기간 후 자동 삭제)

---

## 5. 구현 로드맵

### Phase 1: 랜딩 페이지 애널리틱스 (즉시)

```
새로 생성:
  web/src/analytics/events.ts        # 이벤트 상수 SSOT
  web/src/analytics/provider.tsx     # Umami AnalyticsProvider
  web/src/analytics/hooks.ts         # useTrackEvent, useTrackSection
  web/src/analytics/types.ts         # 타입 정의
  web/src/analytics/config.ts        # Umami 설정 (환경변수 참조)

수정:
  web/src/app/[locale]/layout.tsx    # AnalyticsProvider 래핑
  web/src/components/Hero.tsx        # CTA 클릭 + 섹션 뷰 트래킹
  web/src/components/Problem.tsx     # 섹션 뷰 트래킹
  web/src/components/Solution.tsx    # 섹션 뷰 트래킹
  web/src/components/Philosophy.tsx  # 섹션 뷰 트래킹
  web/next.config.ts                 # Umami 도메인 CSP 허용
  web/.env.example                   # NEXT_PUBLIC_UMAMI_URL, WEBSITE_ID

인프라:
  Railway에 Umami 셀프호스팅 (원클릭 배포 템플릿)
  선택: Cloudflare Web Analytics 병행 (무료 백업)
```

### Phase 2: 서버 사이드 방 메트릭 (채팅 기능 구현 시)

```
  server/analytics/room-metrics.ts   # 방 생성/파괴/종료 + 패킷 카운터
  server/analytics/aggregator.ts     # 시간별/일별 집계 (방 생성수, 전송수, 생존시간)
  server/analytics/cleanup.ts        # TTL 기반 자동 정리 (24시간/7일)
```

### Phase 3: 투명성 + 광고 (성장 단계)

```
  web/src/app/[locale]/transparency/ # 투명성 대시보드 (실시간 KPI 3가지 공개)
  web/src/components/TransparencyBadge.tsx
  web/src/ads/                       # 광고 시스템 (Carbon Ads 추천)
  ANALYTICS.md                       # 수집 데이터 전체 목록 문서
```

---

## 6. 검증 방법

1. **Umami 대시보드**: Railway에서 pageview, 섹션 뷰, CTA 클릭 확인
2. **브라우저 네트워크 탭**: Umami로 전송되는 데이터에 PII가 없는지 확인
3. **쿠키 확인**: Application 탭에서 BLIP 관련 쿠키가 0개인지 확인
4. **인프라 분리 확인**: Umami 요청이 Railway 도메인으로 가는지 (Vercel 아닌지) 확인
5. **CSP 헤더 확인**: Railway Umami 도메인만 허용되어 있는지 확인
6. **오픈소스 검증**: `web/src/analytics/` 디렉토리의 모든 코드가 공개되어 있는지 확인
